<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mathe Lehrplan Mindmap ‚Äì Gymnasium Bayern 5‚Äì7</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #08090d;
  --surface: #12141c;
  --border: #1e2130;
  --text: #eae9e6;
  --muted: #6b6e7f;
  --k5: #f7b731;
  --k5g: #fcd34d;
  --k5d: rgba(247,183,49,0.12);
  --k6: #4f8cff;
  --k6g: #7baeff;
  --k6d: rgba(79,140,255,0.12);
  --k7: #2dd4a8;
  --k7g: #6ee7c0;
  --k7d: rgba(45,212,168,0.12);
  --accent: #a78bfa;
  --dep-direct: #ff6b9d;
  --dep-extends: #fbbf24;
  --dep-prepares: #818cf8;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  font-family: 'Plus Jakarta Sans', sans-serif;
  color: var(--text);
  overflow: hidden;
  height: 100vh;
  width: 100vw;
  cursor: grab;
  user-select: none;
}

body.grabbing { cursor: grabbing; }

#canvas { position: absolute; inset: 0; overflow: hidden; }

#world {
  position: absolute;
  transform-origin: 0 0;
  will-change: transform;
}

/* SVG layers */
#connections, #depLayer {
  position: absolute;
  top: 0; left: 0;
  width: 5000px;
  height: 5000px;
  pointer-events: none;
  z-index: 0;
}

#depLayer { z-index: 1; }

#connections > path {
  fill: none;
  stroke-width: 2;
  opacity: 0;
  animation: pathIn 1s ease-out forwards;
}

@keyframes pathIn { to { opacity: 1; } }

/* Dependency paths ‚Äî only direct children, not marker internals */
.dep-path {
  fill: none;
  stroke-width: 2.5;
  opacity: 0;
  transition: opacity 0.5s cubic-bezier(.4,0,.2,1);
}

.dep-path.dep-visible { opacity: 0.85; }

.dep-path.type-direct { stroke: var(--dep-direct); filter: drop-shadow(0 0 6px rgba(255,107,157,0.3)); }
.dep-path.type-extends { stroke: var(--dep-extends); filter: drop-shadow(0 0 6px rgba(251,191,36,0.3)); }
.dep-path.type-prepares { stroke: var(--dep-prepares); filter: drop-shadow(0 0 6px rgba(129,140,248,0.3)); stroke-dasharray: 8 5; }

/* Animated flow when visible */
.dep-path.dep-visible.type-direct,
.dep-path.dep-visible.type-extends {
  stroke-dasharray: 12 6;
  animation: flowPulse 1.5s linear infinite;
}

.dep-path.dep-visible.type-prepares {
  animation: flowDash 1s linear infinite;
}

@keyframes flowPulse {
  from { stroke-dashoffset: 36; }
  to { stroke-dashoffset: 0; }
}

@keyframes flowDash {
  from { stroke-dashoffset: 26; }
  to { stroke-dashoffset: 0; }
}

/* Dependency label on path */
.dep-label {
  position: absolute;
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  padding: 3px 8px;
  border-radius: 6px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.5s;
  z-index: 3;
  white-space: nowrap;
  backdrop-filter: blur(8px);
}

.dep-label.visible { opacity: 1; }

.dep-label.type-direct { background: rgba(255,107,157,0.15); color: var(--dep-direct); border: 1px solid rgba(255,107,157,0.3); }
.dep-label.type-extends { background: rgba(251,191,36,0.15); color: var(--dep-extends); border: 1px solid rgba(251,191,36,0.3); }
.dep-label.type-prepares { background: rgba(129,140,248,0.15); color: var(--dep-prepares); border: 1px solid rgba(129,140,248,0.3); }

/* Nodes */
.node {
  position: absolute;
  transform: translate(-50%, -50%);
  z-index: 4;
  cursor: pointer;
  transition: transform 0.3s cubic-bezier(.4,0,.2,1), filter 0.3s, opacity 0.4s;
}

.node:hover {
  z-index: 10;
  transform: translate(-50%, -50%) scale(1.06);
  filter: brightness(1.15);
}

.node.dimmed { opacity: 0.15; filter: grayscale(0.5); }
.node.highlighted { opacity: 1 !important; filter: brightness(1.2) !important; z-index: 11; }
.node.highlighted .node-topic { box-shadow: 0 0 30px rgba(255,255,255,0.08); }

/* Central hub */
.node-center {
  width: 220px;
  height: 220px;
  border-radius: 50%;
  background: radial-gradient(circle at 35% 35%, #2a2d45 0%, #1a1d30 50%, #12141c 100%);
  border: 2.5px solid #3e4170;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  box-shadow: 0 0 80px rgba(167,139,250,0.12), 0 0 160px rgba(167,139,250,0.06), inset 0 1px 0 rgba(255,255,255,0.08);
  animation: pulseCenter 4s ease-in-out infinite alternate;
  z-index: 5;
}

@keyframes pulseCenter {
  0% { box-shadow: 0 0 80px rgba(167,139,250,0.12), 0 0 160px rgba(167,139,250,0.06), inset 0 1px 0 rgba(255,255,255,0.08); }
  100% { box-shadow: 0 0 120px rgba(167,139,250,0.2), 0 0 200px rgba(167,139,250,0.1), inset 0 1px 0 rgba(255,255,255,0.12); }
}

.node-center .title {
  font-family: 'Instrument Serif', serif;
  font-size: 21px;
  line-height: 1.25;
  margin-bottom: 8px;
}

.node-center .sub {
  font-size: 11px;
  color: var(--muted);
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

/* Grade orbit nodes */
.node-grade {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  border: 2px solid;
  box-shadow: 0 4px 30px rgba(0,0,0,0.3);
}

.node-grade .num {
  font-family: 'Instrument Serif', serif;
  font-size: 36px;
  line-height: 1;
}

.node-grade .label {
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-top: 4px;
  opacity: 0.7;
}

.node-grade.k5 {
  background: radial-gradient(circle at 35% 35%, rgba(247,183,49,0.18), rgba(247,183,49,0.04));
  border-color: rgba(247,183,49,0.4);
  color: var(--k5);
}
.node-grade.k6 {
  background: radial-gradient(circle at 35% 35%, rgba(79,140,255,0.18), rgba(79,140,255,0.04));
  border-color: rgba(79,140,255,0.4);
  color: var(--k6);
}
.node-grade.k7 {
  background: radial-gradient(circle at 35% 35%, rgba(45,212,168,0.18), rgba(45,212,168,0.04));
  border-color: rgba(45,212,168,0.4);
  color: var(--k7);
}

/* Topic nodes */
.node-topic {
  min-width: 145px;
  max-width: 185px;
  padding: 14px 16px;
  border-radius: 14px;
  background: var(--surface);
  border: 1.5px solid var(--border);
  text-align: center;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  transition: all 0.35s cubic-bezier(.4,0,.2,1);
}

.node-topic .icon { font-size: 24px; margin-bottom: 6px; display: block; }
.node-topic .name { font-size: 13px; font-weight: 600; line-height: 1.35; margin-bottom: 4px; }
.node-topic .hours { font-size: 11px; color: var(--muted); }
.node-topic .dep-count {
  display: none;
  margin-top: 6px;
  font-size: 9px;
  padding: 2px 7px;
  border-radius: 8px;
  font-weight: 600;
}

.node-topic.has-deps .dep-count { display: inline-block; }

.node-topic.k5 { border-color: rgba(247,183,49,0.2); }
.node-topic.k5:hover, .node-topic.k5.active { border-color: rgba(247,183,49,0.5); background: var(--k5d); box-shadow: 0 4px 30px rgba(247,183,49,0.1); }
.node-topic.k6 { border-color: rgba(79,140,255,0.2); }
.node-topic.k6:hover, .node-topic.k6.active { border-color: rgba(79,140,255,0.5); background: var(--k6d); box-shadow: 0 4px 30px rgba(79,140,255,0.1); }
.node-topic.k7 { border-color: rgba(45,212,168,0.2); }
.node-topic.k7:hover, .node-topic.k7.active { border-color: rgba(45,212,168,0.5); background: var(--k7d); box-shadow: 0 4px 30px rgba(45,212,168,0.1); }

/* Info panel */
#infoPanel {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(120%);
  background: rgba(14,16,24,0.96);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 22px 28px 20px;
  max-width: 600px;
  width: calc(100% - 48px);
  z-index: 100;
  backdrop-filter: blur(24px);
  box-shadow: 0 16px 56px rgba(0,0,0,0.6);
  transition: transform 0.45s cubic-bezier(.4,0,.2,1);
}

#infoPanel.show { transform: translateX(-50%) translateY(0); }
#infoPanel.dragged { transition: none; }

.panel-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 14px;
  cursor: grab;
}

.panel-header.grabbing { cursor: grabbing; }

.panel-icon { font-size: 28px; }

.panel-title {
  font-family: 'Instrument Serif', serif;
  font-size: 20px;
  flex: 1;
}

.panel-grade {
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 4px 10px;
  border-radius: 8px;
  font-weight: 600;
}

.panel-items {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 5px 16px;
}

.panel-item {
  font-size: 12px;
  line-height: 1.5;
  color: #b0b2be;
  padding-left: 12px;
  position: relative;
}

.panel-item::before {
  content: '';
  position: absolute;
  left: 0; top: 7px;
  width: 4px; height: 4px;
  border-radius: 50%;
  background: var(--muted);
}

.panel-didaktik {
  margin-top: 12px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
  font-size: 11px;
  color: var(--muted);
  line-height: 1.55;
}

/* Dependency info in panel */
.panel-deps {
  margin-top: 12px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
}

.panel-deps-title {
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 8px;
  font-weight: 600;
}

.panel-dep-item {
  font-size: 11px;
  line-height: 1.5;
  padding: 5px 10px;
  border-radius: 8px;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.panel-dep-item .arrow { font-size: 14px; flex-shrink: 0; }
.panel-dep-item.incoming { background: rgba(255,255,255,0.02); }
.panel-dep-item.outgoing { background: rgba(255,255,255,0.02); }

.dep-type-badge {
  font-size: 8px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 700;
  flex-shrink: 0;
}

.dep-type-badge.type-direct { background: rgba(255,107,157,0.12); color: var(--dep-direct); }
.dep-type-badge.type-extends { background: rgba(251,191,36,0.12); color: var(--dep-extends); }
.dep-type-badge.type-prepares { background: rgba(129,140,248,0.12); color: var(--dep-prepares); }

#closePanel {
  position: absolute;
  top: 14px; right: 16px;
  background: none;
  border: none;
  color: var(--muted);
  font-size: 18px;
  cursor: pointer;
  padding: 4px;
  transition: color 0.2s;
}

#closePanel:hover { color: var(--text); }

/* Toolbar */
#toolbar {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 50;
}

.tool-btn {
  width: 42px;
  height: 42px;
  border-radius: 12px;
  background: rgba(18,20,28,0.92);
  border: 1px solid var(--border);
  color: var(--muted);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  backdrop-filter: blur(10px);
}

.tool-btn:hover { color: var(--text); background: rgba(30,33,48,0.95); }
.tool-btn.active { color: var(--dep-direct); border-color: rgba(255,107,157,0.3); background: rgba(255,107,157,0.06); }
.tool-btn .btn-label {
  display: none;
  font-size: 10px;
  white-space: nowrap;
  margin-left: 6px;
}

/* Dependency toggle panel */
#depPanel {
  position: fixed;
  top: 20px;
  right: 72px;
  z-index: 50;
  background: rgba(14,16,24,0.96);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 16px 18px;
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  opacity: 0;
  pointer-events: none;
  transform: translateX(10px);
  transition: all 0.35s cubic-bezier(.4,0,.2,1);
  width: 240px;
}

#depPanel.show {
  opacity: 1;
  pointer-events: auto;
  transform: translateX(0);
}

#depPanel h3 {
  font-family: 'Instrument Serif', serif;
  font-size: 15px;
  margin-bottom: 12px;
  font-weight: 400;
}

.dep-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  cursor: pointer;
  transition: opacity 0.2s;
}

.dep-toggle:hover { opacity: 0.9; }

.dep-toggle input {
  appearance: none;
  width: 36px;
  height: 20px;
  border-radius: 10px;
  background: var(--border);
  position: relative;
  cursor: pointer;
  transition: background 0.3s;
  flex-shrink: 0;
}

.dep-toggle input::after {
  content: '';
  position: absolute;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--muted);
  top: 2px;
  left: 2px;
  transition: all 0.3s;
}

.dep-toggle input:checked { background: rgba(255,107,157,0.2); }
.dep-toggle input:checked::after { left: 18px; background: var(--dep-direct); }

.dep-toggle.type-extends input:checked { background: rgba(251,191,36,0.2); }
.dep-toggle.type-extends input:checked::after { background: var(--dep-extends); }

.dep-toggle.type-prepares input:checked { background: rgba(129,140,248,0.2); }
.dep-toggle.type-prepares input:checked::after { background: var(--dep-prepares); }

.dep-toggle-label {
  font-size: 12px;
  line-height: 1.3;
}

.dep-toggle-label strong { display: block; font-size: 11px; }
.dep-toggle-label span { color: var(--muted); font-size: 10px; }

.dep-line-sample {
  width: 20px;
  height: 3px;
  border-radius: 2px;
  flex-shrink: 0;
}

.dep-line-sample.type-direct { background: var(--dep-direct); }
.dep-line-sample.type-extends { background: var(--dep-extends); }
.dep-line-sample.type-prepares { background: var(--dep-prepares); border-top: 2px dashed var(--dep-prepares); background: none; height: 0; }

#depPanel .dep-hint {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
  font-size: 10px;
  color: var(--muted);
  line-height: 1.5;
}

/* Header */
#header {
  position: fixed;
  top: 20px;
  left: 24px;
  z-index: 50;
  animation: fadeIn 1s ease-out;
}

#header .badge {
  display: inline-block;
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--accent);
  border: 1px solid rgba(167,139,250,0.2);
  background: rgba(167,139,250,0.06);
  padding: 4px 12px;
  border-radius: 14px;
  margin-bottom: 8px;
}

#header h1 {
  font-family: 'Instrument Serif', serif;
  font-size: 22px;
  font-weight: 400;
}

#header .hint {
  font-size: 11px;
  color: var(--muted);
  margin-top: 4px;
}

/* Legend */
#legend {
  position: fixed;
  bottom: 24px;
  left: 24px;
  z-index: 50;
  display: flex;
  gap: 14px;
  animation: fadeIn 1s ease-out 0.3s both;
}

.leg-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--muted); }
.leg-dot { width: 8px; height: 8px; border-radius: 50%; }

/* Background */
.bg-glow {
  position: fixed;
  border-radius: 50%;
  filter: blur(120px);
  pointer-events: none;
  z-index: 0;
  opacity: 0.3;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.node {
  opacity: 0;
  animation: nodeIn 0.6s cubic-bezier(.4,0,.2,1) forwards;
}

@keyframes nodeIn {
  from { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
  to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

/* Minimap */
#minimap {
  position: fixed;
  bottom: 60px;
  right: 20px;
  width: 140px;
  height: 100px;
  background: rgba(18,20,28,0.85);
  border: 1px solid var(--border);
  border-radius: 10px;
  z-index: 50;
  overflow: hidden;
  backdrop-filter: blur(10px);
  display: none;
}

@media (min-width: 768px) { #minimap { display: block; } }
#minimap canvas { width: 100%; height: 100%; }
#miniViewport {
  position: absolute;
  border: 1px solid rgba(167,139,250,0.5);
  background: rgba(167,139,250,0.06);
  border-radius: 2px;
  pointer-events: none;
}

/* Search bar */
#searchBar {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 55;
  display: flex;
  align-items: center;
  background: rgba(14,16,24,0.92);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 0 14px;
  height: 42px;
  width: 280px;
  backdrop-filter: blur(16px);
  transition: all 0.3s cubic-bezier(.4,0,.2,1);
}

#searchBar:focus-within {
  border-color: rgba(167,139,250,0.4);
  box-shadow: 0 0 20px rgba(167,139,250,0.08);
  width: 340px;
}

.search-icon { font-size: 14px; margin-right: 8px; flex-shrink: 0; }

#searchInput {
  background: none;
  border: none;
  color: var(--text);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 13px;
  outline: none;
  flex: 1;
  min-width: 0;
}

#searchInput::placeholder { color: var(--muted); }

#searchClear {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 14px;
  cursor: pointer;
  padding: 2px 4px;
  display: none;
  transition: color 0.2s;
}

#searchClear:hover { color: var(--text); }

#searchResults {
  position: absolute;
  top: 48px;
  left: 0;
  right: 0;
  background: rgba(14,16,24,0.96);
  border: 1px solid var(--border);
  border-radius: 12px;
  max-height: 260px;
  overflow-y: auto;
  display: none;
  backdrop-filter: blur(20px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.5);
}

.search-result {
  padding: 10px 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background 0.15s;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}

.search-result:last-child { border-bottom: none; }
.search-result:hover { background: rgba(255,255,255,0.04); }

.search-result .sr-icon { font-size: 18px; flex-shrink: 0; }
.search-result .sr-name { font-size: 12px; font-weight: 600; }
.search-result .sr-grade { font-size: 10px; color: var(--muted); margin-left: auto; flex-shrink: 0; }

/* Class filter */
#classFilter {
  position: fixed;
  top: 72px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 55;
  display: flex;
  gap: 6px;
  animation: fadeIn 0.6s ease-out 0.5s both;
}

.filter-btn {
  padding: 5px 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(14,16,24,0.85);
  color: var(--muted);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s cubic-bezier(.4,0,.2,1);
  backdrop-filter: blur(10px);
}

.filter-btn:hover { color: var(--text); background: rgba(30,33,48,0.95); }

.filter-btn.active { color: var(--text); border-color: rgba(167,139,250,0.4); background: rgba(167,139,250,0.1); }

.filter-btn.k5.active { color: var(--k5); border-color: rgba(247,183,49,0.4); background: rgba(247,183,49,0.1); }
.filter-btn.k6.active { color: var(--k6); border-color: rgba(79,140,255,0.4); background: rgba(79,140,255,0.1); }
.filter-btn.k7.active { color: var(--k7); border-color: rgba(45,212,168,0.4); background: rgba(45,212,168,0.1); }

/* Node visibility for filters */
.node.grade-hidden {
  opacity: 0.06 !important;
  pointer-events: none;
  filter: grayscale(1);
  transition: opacity 0.4s, filter 0.4s;
}

.node.search-match {
  z-index: 12 !important;
}

.node.search-match::after {
  content: '';
  position: absolute;
  inset: -6px;
  border-radius: 18px;
  border: 2px solid var(--accent);
  animation: searchPulse 1.5s ease-in-out infinite;
  pointer-events: none;
}

@keyframes searchPulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 1; }
}

@media (max-width: 640px) {
  .panel-items { grid-template-columns: 1fr; }
  #depPanel { right: 60px; width: 210px; }
  #searchBar { width: 200px; top: 14px; }
  #searchBar:focus-within { width: 260px; }
  #classFilter { top: 64px; }
}
</style>
</head>
<body>

<div class="bg-glow" style="width:500px;height:500px;top:-100px;left:-100px;background:rgba(247,183,49,0.06)"></div>
<div class="bg-glow" style="width:600px;height:600px;bottom:-200px;left:30%;background:rgba(79,140,255,0.05)"></div>
<div class="bg-glow" style="width:500px;height:500px;top:20%;right:-100px;background:rgba(45,212,168,0.05)"></div>

<div id="header">
  <div class="badge">LehrplanPLUS Bayern ¬∑ G9</div>
  <h1>Mathematik Mindmap ¬∑ Klasse 5‚Äì7</h1>
  <div class="hint">Ziehen ‚Üí Bewegen ¬∑ Scrollen ‚Üí Zoomen ¬∑ Klick ‚Üí Details ¬∑ F ‚Üí Suche ¬∑ 1/2/3 ‚Üí Klasse filtern</div>
</div>

<div id="toolbar">
  <button class="tool-btn" onclick="zoomIn()" title="Vergr√∂√üern">+</button>
  <button class="tool-btn" onclick="zoomOut()" title="Verkleinern">‚àí</button>
  <button class="tool-btn" onclick="resetView()" title="Ansicht zur√ºcksetzen">‚åÇ</button>
  <button class="tool-btn" id="depToggleBtn" onclick="toggleDepPanel()" title="Abh√§ngigkeiten anzeigen">üîó</button>
</div>

<div id="depPanel">
  <h3>Abh√§ngigkeiten & Aufbau</h3>
  
  <label class="dep-toggle type-direct">
    <input type="checkbox" onchange="toggleDepType('direct', this.checked)" checked>
    <div class="dep-line-sample type-direct"></div>
    <div class="dep-toggle-label">
      <strong>Direkte Grundlage</strong>
      <span>Thema A ist Voraussetzung f√ºr B</span>
    </div>
  </label>
  
  <label class="dep-toggle type-extends">
    <input type="checkbox" onchange="toggleDepType('extends', this.checked)" checked>
    <div class="dep-line-sample type-extends"></div>
    <div class="dep-toggle-label">
      <strong>Wird vertieft / erweitert</strong>
      <span>Gleiches Thema kehrt erweitert wieder</span>
    </div>
  </label>
  
  <label class="dep-toggle type-prepares">
    <input type="checkbox" onchange="toggleDepType('prepares', this.checked)" checked>
    <div class="dep-line-sample type-prepares"></div>
    <div class="dep-toggle-label">
      <strong>Bereitet vor auf</strong>
      <span>Indirekte Vorbereitung f√ºr sp√§tere Themen</span>
    </div>
  </label>
  
  <div class="dep-hint">
    üí° Klicke auf einen Knoten um nur dessen Abh√§ngigkeiten zu sehen. Klicke ins Leere zum Zur√ºcksetzen.
  </div>
</div>

<!-- Search bar -->
<div id="searchBar">
  <span class="search-icon">üîç</span>
  <input type="text" id="searchInput" placeholder="Thema suchen‚Ä¶" autocomplete="off">
  <button id="searchClear" onclick="clearSearch()">‚úï</button>
  <div id="searchResults"></div>
</div>

<!-- Class filter -->
<div id="classFilter">
  <button class="filter-btn active" data-grade="all" onclick="filterGrade('all')">Alle</button>
  <button class="filter-btn k5" data-grade="k5" onclick="filterGrade('k5')">Kl. 5</button>
  <button class="filter-btn k6" data-grade="k6" onclick="filterGrade('k6')">Kl. 6</button>
  <button class="filter-btn k7" data-grade="k7" onclick="filterGrade('k7')">Kl. 7</button>
</div>

<div id="legend">
  <div class="leg-item"><div class="leg-dot" style="background:var(--k5)"></div>Klasse 5</div>
  <div class="leg-item"><div class="leg-dot" style="background:var(--k6)"></div>Klasse 6</div>
  <div class="leg-item"><div class="leg-dot" style="background:var(--k7)"></div>Klasse 7</div>
</div>

<div id="canvas">
  <div id="world">
    <svg id="connections" width="5000" height="5000"></svg>
    <svg id="depLayer" width="5000" height="5000">
      <defs>
        <marker id="arrow-direct" viewBox="0 0 10 7" refX="9" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
          <path d="M0,0 L10,3.5 L0,7 Z" fill="var(--dep-direct)"/>
        </marker>
        <marker id="arrow-extends" viewBox="0 0 10 7" refX="9" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
          <path d="M0,0 L10,3.5 L0,7 Z" fill="var(--dep-extends)"/>
        </marker>
        <marker id="arrow-prepares" viewBox="0 0 10 7" refX="9" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
          <path d="M0,0 L10,3.5 L0,7 Z" fill="var(--dep-prepares)"/>
        </marker>
      </defs>
    </svg>
  </div>
</div>

<div id="infoPanel">
  <button id="closePanel" onclick="closePanel()">‚úï</button>
  <div class="panel-header">
    <span class="panel-icon" id="panelIcon"></span>
    <span class="panel-title" id="panelTitle"></span>
    <span class="panel-grade" id="panelGrade"></span>
  </div>
  <div class="panel-items" id="panelItems"></div>
  <div class="panel-didaktik" id="panelDidaktik"></div>
  <div class="panel-deps" id="panelDeps"></div>
</div>

<div id="minimap">
  <canvas id="minimapCanvas"></canvas>
  <div id="miniViewport"></div>
</div>

<script>
const CX = 2500, CY = 2500;

const grades = [
  { id:'k5', label:'Klasse 5', num:'5', color:'#f7b731', angle:210 },
  { id:'k6', label:'Klasse 6', num:'6', color:'#4f8cff', angle:330 },
  { id:'k7', label:'Klasse 7', num:'7', color:'#2dd4a8', angle:90 },
];

// Grade filter state
const gradeVisible = { k5: true, k6: true, k7: true };

const topics = [
  { id:'t5_1', grade:'k5', icon:'üî¢', name:'Nat√ºrliche &\nganze Zahlen', hours:'30 Std.', angle:-45,
    items:['Stellenwertsystem (Zehnersystem)','Zahlenstrahl & Zahlengerade','Runden nat√ºrlicher Zahlen','Erweiterung ‚Ñï ‚Üí ‚Ñ§','Ordnen, Betrag, negative Zahlen','Gegenbeispiele zum Widerlegen'],
    didaktik:'Ankn√ºpfung an Grundschule (4. Klasse) ¬∑ Zahlenraum wird auf ganze Zahlen erweitert ¬∑ Erste Beweisideen durch Gegenbeispiele ¬∑ Grundlage f√ºr alle Rechenoperationen' },
  { id:'t5_2', grade:'k5', icon:'‚ûï', name:'Addition &\nSubtraktion', hours:'30 Std.', angle:-18,
    items:['Addieren & Subtrahieren in ‚Ñï','Kommutativ- & Assoziativgesetz','Rechenvorteile nutzen','Addition & Subtraktion in ‚Ñ§','Sachaufgaben (Temperatur, Konto)'],
    didaktik:'Rechengesetze als Fundament f√ºr Termumformungen in Kl. 7 ¬∑ Sachkontexte f√∂rdern Modellierungskompetenz' },
  { id:'t5_3', grade:'k5', icon:'‚úñÔ∏è', name:'Multiplikation,\nDivision, Potenzen', hours:'30 Std.', angle:10,
    items:['Multiplikation & Division in ‚Ñï','Potenzschreibweise','Teilbarkeit & Primzahlen','Primfaktorzerlegung','Terme & Rechenregeln','Z√§hlprinzip & Baumdiagramme'],
    didaktik:'Primfaktorzerlegung ‚Üí Grundlage f√ºr kgV/ggT bei Br√ºchen (Kl. 6) ¬∑ Baumdiagramme als erster Stochastik-Kontakt ¬∑ Potenzschreibweise wird in Kl. 7 bei Termen wieder aufgegriffen' },
  { id:'t5_4', grade:'k5', icon:'üìê', name:'Geometrische\nGrundbegriffe', hours:'22 Std.', angle:40,
    items:['Punkt, Gerade, Strecke, Strahl','Winkel: Messen & Zeichnen','Senkrecht & parallel','Koordinatensystem (4 Quadranten)','Achsensymmetrie'],
    didaktik:'Exaktes Konstruieren mit Geodreieck & Zirkel ¬∑ Koordinatensystem als Br√ºcke zur Algebra ¬∑ Symmetrie als Vorbereitung f√ºr Kongruenz (Kl. 7)' },
  { id:'t5_5', grade:'k5', icon:'üìè', name:'Gr√∂√üen &\nSchlussrechnung', hours:'26 Std.', angle:68,
    items:['L√§nge, Masse, Zeit, Geld','Einheiten umrechnen','Ma√üstab & Diagramme','Dreisatz (Schlussrechnung)','Proportionalit√§t in Sachaufgaben'],
    didaktik:'Starker Alltagsbezug f√∂rdert Modellierung ¬∑ Dreisatz als zentrale Grundlage f√ºr Prozentrechnung (Kl. 6) ¬∑ Ma√üstab verbindet mit Geometrie' },
  { id:'t5_6', grade:'k5', icon:'‚ñ≠', name:'Fl√§chen-\ninhalt', hours:'12 Std.', angle:97,
    items:['Fl√§cheneinheiten (mm¬≤‚Äìkm¬≤)','Rechteck & Quadrat','Zusammengesetzte Fl√§chen'],
    didaktik:'Grundlage f√ºr Dreieck, Parallelogramm, Trapez in Kl. 6 ¬∑ Zerlegungsprinzip als wichtige Probleml√∂sestrategie' },
  
  { id:'t6_1', grade:'k6', icon:'¬Ω', name:'Bruchteile &\nBruchzahlen', hours:'13 Std.', angle:-45,
    items:['Anteile & Bruchteile','Erweitern & K√ºrzen','Hauptnenner & Gr√∂√üenvergleich','Kreis- & Rechteckdiagramme','Prozent als Bruchschreibweise'],
    didaktik:'Baut auf Teilbarkeit & Primfaktorzerlegung (Kl. 5) auf ¬∑ Anschauliche Einf√ºhrung √ºber Fl√§chen- und Kreismodelle ¬∑ Grundlage f√ºr gesamte Bruchrechnung' },
  { id:'t6_2', grade:'k6', icon:'‚Öì', name:'Rechnen mit\nBr√ºchen', hours:'30 Std.', angle:-18,
    items:['Addition & Subtraktion','Multiplikation & Division','Gemischte Zahlen','Doppelbr√ºche & Potenzen','Dezimalbr√ºche & Umwandlung'],
    didaktik:'Kernkompetenz f√ºr alle h√∂heren Klassen ¬∑ √úbergang zu Dezimalschreibweise ¬∑ Bruchrechnung trainiert algebraisches Denken' },
  { id:'t6_3', grade:'k6', icon:'¬±', name:'Rationale\nZahlen', hours:'25 Std.', angle:10,
    items:['Erweiterung ‚Ñ§ ‚Üí ‚Ñö','Negative Br√ºche','Rechnen in ‚Ñö','Zahlenstrahl f√ºr ‚Ñö','Betrag rationaler Zahlen'],
    didaktik:'Zusammenf√ºhrung: ganze Zahlen + Br√ºche ‚Üí vollst√§ndiger Zahlbereich ‚Ñö ¬∑ N√∂tig als Grundlage f√ºr Terme mit Variablen (Kl. 7)' },
  { id:'t6_4', grade:'k6', icon:'%', name:'Prozent-\nrechnung', hours:'14 Std.', angle:38,
    items:['Prozent = Bruch mit Nenner 100','Grundwert, Prozentwert, Prozentsatz','Einfache Alltagsaufgaben'],
    didaktik:'Baut auf Dreisatz und Bruchrechnung auf ¬∑ Wird in Kl. 7 mit komplexen Anwendungen deutlich vertieft' },
  { id:'t6_5', grade:'k6', icon:'üìä', name:'Daten &\nDiagramme', hours:'8 Std.', angle:66,
    items:['Daten erheben & darstellen','Absolute & relative H√§ufigkeit','Arithmetisches Mittel','Diagramme kritisch lesen'],
    didaktik:'F√∂rdert Medienkompetenz & kritisches Denken ¬∑ Grundlage f√ºr Median und Boxplots in Kl. 7 ¬∑ Alltagsrelevanz durch Zeitungsdiagramme' },
  { id:'t6_6', grade:'k6', icon:'üì¶', name:'Fl√§cheninhalt\n& Volumen', hours:'30 Std.', angle:95,
    items:['Dreieck, Parallelogramm, Trapez','Umfang & Fl√§cheninhalt','Schr√§gbilder & Netze','Oberfl√§che & Volumen (Quader)','Volumeneinheiten'],
    didaktik:'Vertieft Fl√§chen aus Kl. 5 ¬∑ Erster Schritt in Raumgeometrie ¬∑ Schr√§gbilder f√∂rdern r√§umliches Vorstellungsverm√∂gen' },
  
  { id:'t7_1', grade:'k7', icon:'ùë•', name:'Terme mit\nVariablen', hours:'28 Std.', angle:-40,
    items:['Variable als Platzhalter','Terme aufstellen & vereinfachen','Gleichartige Terme zusammenfassen','Distributivgesetz','Ausmultiplizieren & Ausklammern'],
    didaktik:'Der gro√üe √úbergang: Arithmetik ‚Üí Algebra ¬∑ Baut auf Rechengesetzen (Kl. 5) und Zahlbereich ‚Ñö (Kl. 6) auf ¬∑ Schl√ºsselkompetenz f√ºr gesamte Oberstufe' },
  { id:'t7_2', grade:'k7', icon:'‚öñÔ∏è', name:'Lineare\nGleichungen', hours:'22 Std.', angle:-12,
    items:['√Ñquivalenzumformungen','L√∂sen linearer Gleichungen','Sachaufgaben mit Gleichungsansatz','Ungleichungen (Einf√ºhrung)'],
    didaktik:'Waagemodell als Veranschaulichung ¬∑ Grundlage f√ºr Gleichungssysteme (Kl. 8) ¬∑ Sachaufgaben st√§rken Modellierungskompetenz' },
  { id:'t7_3', grade:'k7', icon:'üìà', name:'Prozentrechnung\nvertieft', hours:'16 Std.', angle:18,
    items:['Komplexe Aufgaben (Rabatt, Zins)','Prozentuale Ver√§nderung','Verkn√ºpfung mit Gleichungen','Kritische Bewertung'],
    didaktik:'Gesellschaftliche Kontexte (Rabatte, Zinsen, Statistiken) ¬∑ Unterscheidung mathematisch vs. au√üerfachlich ¬∑ F√∂rdert m√ºndiges Verbraucherverhalten' },
  { id:'t7_4', grade:'k7', icon:'üìâ', name:'Kenngr√∂√üen\nvon Daten', hours:'14 Std.', angle:48,
    items:['Median als Mittelwert','Spannweite & Quartile','Boxplots erstellen','Mittelwert vs. Median vergleichen'],
    didaktik:'Vertieft Mittelwert aus Kl. 6 ¬∑ Kritisches Denken bei Dateninterpretation ¬∑ Vorbereitung auf Wahrscheinlichkeitsrechnung (Kl. 8)' },
  { id:'t7_5', grade:'k7', icon:'‚ñ≥', name:'Figuren-\ngeometrie', hours:'40 Std.', angle:80,
    items:['Winkel an Geradenkreuzungen','Winkelsumme Dreieck & Viereck','Kongruenz (SSS, SWS, WSW, SsW)','Dreieckskonstruktion','Besondere Linien im Dreieck','Punktsymmetrie'],
    didaktik:'Erste formale Beweise ¬∑ Kongruenzs√§tze als Grundlage f√ºr √Ñhnlichkeit & Pythagoras (Kl. 9) ¬∑ F√∂rdert logisches Schlussfolgern' },
];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DEPENDENCIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const dependencies = [
  // DIRECT: A ist direkte Voraussetzung f√ºr B
  { from:'t5_3', to:'t6_1', type:'direct', label:'Primfaktorzerlegung ‚Üí kgV/ggT f√ºr Br√ºche' },
  { from:'t5_1', to:'t6_3', type:'direct', label:'Ganze Zahlen ‚Ñ§ ‚Üí Rationale Zahlen ‚Ñö' },
  { from:'t6_1', to:'t6_2', type:'direct', label:'Bruchbegriff ‚Üí Bruchrechnung' },
  { from:'t6_2', to:'t6_3', type:'direct', label:'Bruchrechnung ‚Üí Rechnen in ‚Ñö' },
  { from:'t6_3', to:'t7_1', type:'direct', label:'Zahlbereich ‚Ñö ‚Üí Terme mit Variablen' },
  { from:'t5_2', to:'t7_1', type:'direct', label:'Rechengesetze ‚Üí Termumformungen' },
  { from:'t7_1', to:'t7_2', type:'direct', label:'Terme ‚Üí Lineare Gleichungen' },
  { from:'t5_5', to:'t6_4', type:'direct', label:'Dreisatz ‚Üí Prozentrechnung' },
  { from:'t6_2', to:'t6_4', type:'direct', label:'Bruchrechnung ‚Üí Prozent als Bruch' },
  { from:'t7_2', to:'t7_3', type:'direct', label:'Gleichungen ‚Üí Komplexe Prozentaufgaben' },
  { from:'t5_4', to:'t7_5', type:'direct', label:'Winkel & Symmetrie ‚Üí Figurengeometrie' },

  // EXTENDS: Gleiches Thema wird in sp√§terer Klasse vertieft
  { from:'t5_6', to:'t6_6', type:'extends', label:'Rechteckfl√§che ‚Üí Dreieck, Trapez, Volumen' },
  { from:'t6_4', to:'t7_3', type:'extends', label:'Grundlagen % ‚Üí Vertiefte Prozentrechnung' },
  { from:'t6_5', to:'t7_4', type:'extends', label:'Mittelwert & Diagramme ‚Üí Median, Boxplots' },
  { from:'t6_6', to:'t7_5', type:'extends', label:'Fl√§chen & K√∂rper ‚Üí Kongruenz & Konstruktion' },
  { from:'t5_4', to:'t6_6', type:'extends', label:'Grundbegriffe ‚Üí Fl√§chenberechnung' },

  // PREPARES: Indirekte Vorbereitung auf sp√§tere Themen
  { from:'t5_3', to:'t6_5', type:'prepares', label:'Baumdiagramme ‚Üí Daten & H√§ufigkeit' },
  { from:'t5_1', to:'t5_2', type:'prepares', label:'Zahlverst√§ndnis ‚Üí Rechenoperationen' },
  { from:'t6_2', to:'t7_1', type:'prepares', label:'Bruchrechnung trainiert f√ºr Algebra' },
  { from:'t5_4', to:'t5_6', type:'prepares', label:'Geometr. Grundbegriffe ‚Üí Fl√§chenberechnung' },
  { from:'t7_5', to:'t7_5_future', type:'prepares', label:'‚Üí √Ñhnlichkeit & Pythagoras (Kl. 9)', isFuture:true },
  { from:'t7_2', to:'t7_2_future', type:'prepares', label:'‚Üí Gleichungssysteme (Kl. 8)', isFuture:true },
  { from:'t7_4', to:'t7_4_future', type:'prepares', label:'‚Üí Wahrscheinlichkeit (Kl. 8)', isFuture:true },
];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GRADE_R = 350, TOPIC_R = 270;
const gradePos = {}, topicPos = {};

grades.forEach(g => {
  const a = g.angle * Math.PI / 180;
  g.x = CX + Math.cos(a) * GRADE_R;
  g.y = CY + Math.sin(a) * GRADE_R;
  gradePos[g.id] = { x:g.x, y:g.y };
});

topics.forEach(t => {
  const gp = gradePos[t.grade];
  const baseAngle = grades.find(g=>g.id===t.grade).angle;
  const a = (baseAngle + t.angle) * Math.PI / 180;
  t.x = gp.x + Math.cos(a) * TOPIC_R;
  t.y = gp.y + Math.sin(a) * TOPIC_R;
  topicPos[t.id] = { x:t.x, y:t.y };
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const world = document.getElementById('world');
const svg = document.getElementById('connections');
const depSvg = document.getElementById('depLayer');

const nodeElements = {};

let nodeWasDragged = false;

function createNode(type, cls, x, y, content, delay, onclick) {
  const div = document.createElement('div');
  div.className = `node ${type} ${cls}`;
  div.style.left = x+'px';
  div.style.top = y+'px';
  div.style.animationDelay = delay+'s';
  div.innerHTML = content;
  if (onclick) div.addEventListener('click', e => { e.stopPropagation(); if (!nodeWasDragged) onclick(); });
  world.appendChild(div);
  return div;
}

function bezier(x1,y1,x2,y2) {
  const dx=x2-x1, dy=y2-y1;
  const cx1=x1+dx*0.4, cy1=y1+dy*0.1;
  const cx2=x2-dx*0.4, cy2=y2-dy*0.1;
  return `M${x1},${y1} C${cx1},${cy1} ${cx2},${cy2} ${x2},${y2}`;
}

const structPaths = {}; // keyed by topic/grade id

function structPath(x1,y1,x2,y2,color,delay,key) {
  const p = document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('d', bezier(x1,y1,x2,y2));
  p.setAttribute('stroke', color);
  p.style.animationDelay = delay+'s';
  svg.appendChild(p);
  if (key) structPaths[key] = { el:p, x1,y1,x2,y2,color };
  return p;
}

// Center
createNode('node-center','',CX,CY,
  `<div class="title">Mathematik<br>Gymnasium Bayern</div><div class="sub">Klasse 5 ‚Äì 7</div>`,0);

// Grades
grades.forEach((g,i) => {
  structPath(CX,CY,g.x,g.y,g.color+'55',i*0.1,g.id);
  const el = createNode('node-grade',g.id,g.x,g.y,
    `<div class="num">${g.num}</div><div class="label">${g.label}</div>`,0.2+i*0.1);
  el.dataset.nodeId = g.id;
  nodeElements[g.id] = el;
});

// Topics
topics.forEach((t,i) => {
  const gp = gradePos[t.grade];
  const g = grades.find(g=>g.id===t.grade);
  structPath(gp.x,gp.y,t.x,t.y,g.color+'33',0.3+i*0.04,t.id);
  
  const depCount = dependencies.filter(d=>d.from===t.id||d.to===t.id).filter(d=>!d.isFuture).length;
  const futureCount = dependencies.filter(d=>d.from===t.id&&d.isFuture).length;
  
  const el = createNode('node-topic',t.grade,t.x,t.y,
    `<span class="icon">${t.icon}</span><div class="name">${t.name.replace(/\n/g,'<br>')}</div><div class="hours">${t.hours}</div>` +
    (depCount > 0 ? `<div class="dep-count" style="background:rgba(255,255,255,0.05);color:var(--muted)">üîó ${depCount}${futureCount?' +'+futureCount:''}</div>` : ''),
    0.4+i*0.04,
    () => selectTopic(t.id)
  );
  el.dataset.nodeId = t.id;
  if (depCount > 0 || futureCount > 0) el.classList.add('has-deps');
  nodeElements[t.id] = el;
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DEPENDENCY RENDERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const depPaths = {};
const depLabels = {};
const depTypeVisible = { direct: true, extends: true, prepares: true };
let depPanelOpen = false;
let selectedTopicId = null;

function createDepPath(dep) {
  if (dep.isFuture) return;
  const from = topicPos[dep.from];
  const to = topicPos[dep.to];
  if (!from || !to) return;

  const p = document.createElementNS('http://www.w3.org/2000/svg','path');
  const d = bezier(from.x, from.y, to.x, to.y);
  p.setAttribute('d', d);
  p.classList.add('dep-path', `type-${dep.type}`);
  p.setAttribute('marker-end', `url(#arrow-${dep.type})`);
  depSvg.appendChild(p);
  
  const key = `${dep.from}-${dep.to}`;
  depPaths[key] = p;

  // Label
  const lbl = document.createElement('div');
  lbl.className = `dep-label type-${dep.type}`;
  lbl.textContent = dep.label;
  lbl.style.left = ((from.x+to.x)/2) + 'px';
  lbl.style.top = ((from.y+to.y)/2 - 14) + 'px';
  lbl.style.transform = 'translate(-50%, -50%)';
  world.appendChild(lbl);
  depLabels[key] = lbl;
}

dependencies.forEach(d => createDepPath(d));

function updateDepVisibility() {
  dependencies.forEach(dep => {
    if (dep.isFuture) return;
    const key = `${dep.from}-${dep.to}`;
    const p = depPaths[key];
    const l = depLabels[key];
    if (!p) return;
    
    const typeOn = depTypeVisible[dep.type];
    const topicMatch = !selectedTopicId || dep.from === selectedTopicId || dep.to === selectedTopicId;
    const visible = depPanelOpen && typeOn && topicMatch;
    
    p.classList.toggle('dep-visible', visible);
    if (l) l.classList.toggle('visible', visible);
  });
  
  // Dim/highlight nodes when a topic is selected
  if (selectedTopicId && depPanelOpen) {
    const related = new Set([selectedTopicId]);
    dependencies.forEach(dep => {
      if (dep.isFuture) return;
      if (!depTypeVisible[dep.type]) return;
      if (dep.from === selectedTopicId) related.add(dep.to);
      if (dep.to === selectedTopicId) related.add(dep.from);
    });
    
    Object.entries(nodeElements).forEach(([id, el]) => {
      if (id.startsWith('k')) { el.classList.remove('dimmed','highlighted'); return; }
      if (related.has(id)) {
        el.classList.add('highlighted');
        el.classList.remove('dimmed');
      } else {
        el.classList.add('dimmed');
        el.classList.remove('highlighted');
      }
    });
  } else {
    Object.values(nodeElements).forEach(el => {
      el.classList.remove('dimmed','highlighted');
    });
  }
}

function selectTopic(id) {
  const t = topics.find(t=>t.id===id);
  if (!t) return;
  
  if (selectedTopicId === id) {
    selectedTopicId = null;
  } else {
    selectedTopicId = id;
    if (!depPanelOpen) {
      depPanelOpen = true;
      document.getElementById('depToggleBtn').classList.add('active');
      document.getElementById('depPanel').classList.add('show');
    }
  }
  
  showPanel(t);
  updateDepVisibility();
}

function toggleDepPanel() {
  depPanelOpen = !depPanelOpen;
  document.getElementById('depToggleBtn').classList.toggle('active', depPanelOpen);
  document.getElementById('depPanel').classList.toggle('show', depPanelOpen);
  if (!depPanelOpen) selectedTopicId = null;
  updateDepVisibility();
}

function toggleDepType(type, on) {
  depTypeVisible[type] = on;
  updateDepVisibility();
}

// Click on empty space to deselect
document.getElementById('canvas').addEventListener('click', e => {
  if (!e.target.closest('.node')) {
    selectedTopicId = null;
    updateDepVisibility();
    closePanel();
  }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ INFO PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const infoPanel = document.getElementById('infoPanel');

function showPanel(t) {
  const g = grades.find(g=>g.id===t.grade);
  document.getElementById('panelIcon').textContent = t.icon;
  document.getElementById('panelTitle').textContent = t.name.replace(/\n/g,' ');
  
  const gradeEl = document.getElementById('panelGrade');
  gradeEl.textContent = g.label+' ¬∑ '+t.hours;
  gradeEl.style.background = g.color+'18';
  gradeEl.style.color = g.color;
  gradeEl.style.border = `1px solid ${g.color}33`;
  
  document.getElementById('panelItems').innerHTML = t.items.map(i=>`<div class="panel-item">${i}</div>`).join('');
  document.getElementById('panelDidaktik').textContent = 'üí° '+t.didaktik;
  
  // Build dependency section
  const incoming = dependencies.filter(d=>d.to===t.id && !d.isFuture);
  const outgoing = dependencies.filter(d=>d.from===t.id);
  
  let depHtml = '';
  if (incoming.length > 0 || outgoing.length > 0) {
    depHtml += '<div class="panel-deps-title">üîó Abh√§ngigkeiten</div>';
    
    if (incoming.length > 0) {
      incoming.forEach(d => {
        const fromT = topics.find(t=>t.id===d.from);
        const typeLabels = { direct:'Grundlage', extends:'Vertiefung von', prepares:'Vorbereitet durch' };
        depHtml += `<div class="panel-dep-item incoming">
          <span class="arrow">‚Üê</span>
          <span class="dep-type-badge type-${d.type}">${typeLabels[d.type]}</span>
          <span>${fromT ? fromT.icon+' '+fromT.name.replace(/\n/g,' ') : '?'}: ${d.label}</span>
        </div>`;
      });
    }
    
    if (outgoing.length > 0) {
      outgoing.forEach(d => {
        const toT = topics.find(t=>t.id===d.to);
        const typeLabels = { direct:'Grundlage f√ºr', extends:'Wird vertieft in', prepares:'Bereitet vor' };
        const targetName = d.isFuture ? d.label : (toT ? toT.icon+' '+toT.name.replace(/\n/g,' ') : '?');
        depHtml += `<div class="panel-dep-item outgoing">
          <span class="arrow">‚Üí</span>
          <span class="dep-type-badge type-${d.type}">${typeLabels[d.type]}</span>
          <span>${d.isFuture ? d.label : targetName + ': ' + d.label}</span>
        </div>`;
      });
    }
  }
  
  document.getElementById('panelDeps').innerHTML = depHtml;
  infoPanel.classList.add('show');
  
  document.querySelectorAll('.node-topic').forEach(n => n.classList.remove('active'));
  const el = nodeElements[t.id];
  if (el) el.classList.add('active');
}

function closePanel() {
  infoPanel.classList.remove('show');
  infoPanel.classList.remove('dragged');
  infoPanel.style.left = '';
  infoPanel.style.top = '';
  infoPanel.style.bottom = '';
  infoPanel.style.transform = '';
  document.querySelectorAll('.node-topic').forEach(n => n.classList.remove('active'));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PANEL DRAG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{
  const header = infoPanel.querySelector('.panel-header');
  let pdrag = false, psx, psy, pelx, pely;

  header.addEventListener('mousedown', e => {
    if (e.target.closest('#closePanel')) return;
    e.preventDefault();
    pdrag = true;
    header.classList.add('grabbing');

    const rect = infoPanel.getBoundingClientRect();
    // Switch to top/left positioning on first drag
    if (!infoPanel.classList.contains('dragged')) {
      infoPanel.classList.add('dragged');
      infoPanel.style.left = rect.left + 'px';
      infoPanel.style.top = rect.top + 'px';
      infoPanel.style.bottom = 'auto';
      infoPanel.style.transform = 'none';
    }
    psx = e.clientX;
    psy = e.clientY;
    pelx = rect.left;
    pely = rect.top;
  });

  window.addEventListener('mousemove', e => {
    if (!pdrag) return;
    const nx = pelx + (e.clientX - psx);
    const ny = pely + (e.clientY - psy);
    infoPanel.style.left = nx + 'px';
    infoPanel.style.top = ny + 'px';
  });

  window.addEventListener('mouseup', () => {
    if (pdrag) {
      pdrag = false;
      header.classList.remove('grabbing');
    }
  });

  // Touch support
  header.addEventListener('touchstart', e => {
    if (e.target.closest('#closePanel')) return;
    pdrag = true;
    const touch = e.touches[0];
    const rect = infoPanel.getBoundingClientRect();
    if (!infoPanel.classList.contains('dragged')) {
      infoPanel.classList.add('dragged');
      infoPanel.style.left = rect.left + 'px';
      infoPanel.style.top = rect.top + 'px';
      infoPanel.style.bottom = 'auto';
      infoPanel.style.transform = 'none';
    }
    psx = touch.clientX;
    psy = touch.clientY;
    pelx = rect.left;
    pely = rect.top;
  }, { passive: true });

  header.addEventListener('touchmove', e => {
    if (!pdrag) return;
    e.preventDefault();
    const touch = e.touches[0];
    infoPanel.style.left = (pelx + touch.clientX - psx) + 'px';
    infoPanel.style.top = (pely + touch.clientY - psy) + 'px';
  }, { passive: false });

  header.addEventListener('touchend', () => { pdrag = false; });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ NODE DRAG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let nodeDrag = null; // { id, el, sx, sy } ‚Äì active drag state

function updateNodeLines(id) {
  const pos = topicPos[id];
  if (!pos) return;

  // Update structural path (grade ‚Üí topic)
  const sp = structPaths[id];
  if (sp) {
    sp.x2 = pos.x; sp.y2 = pos.y;
    sp.el.setAttribute('d', bezier(sp.x1, sp.y1, sp.x2, sp.y2));
  }

  // Update dependency paths & labels
  dependencies.forEach(dep => {
    if (dep.isFuture) return;
    if (dep.from !== id && dep.to !== id) return;
    const key = `${dep.from}-${dep.to}`;
    const p = depPaths[key];
    const l = depLabels[key];
    const from = topicPos[dep.from];
    const to = topicPos[dep.to];
    if (!p || !from || !to) return;
    p.setAttribute('d', bezier(from.x, from.y, to.x, to.y));
    if (l) {
      l.style.left = ((from.x + to.x) / 2) + 'px';
      l.style.top = ((from.y + to.y) / 2 - 14) + 'px';
    }
  });
}

// Attach drag handlers to every topic node
Object.entries(nodeElements).forEach(([id, el]) => {
  if (!id.startsWith('t')) return; // only topic nodes

  el.addEventListener('mousedown', e => {
    e.stopPropagation();
    nodeDrag = { id, el, sx: e.clientX, sy: e.clientY,
      ox: topicPos[id].x, oy: topicPos[id].y };
  });

  el.addEventListener('touchstart', e => {
    if (e.touches.length !== 1) return;
    e.stopPropagation();
    const t = e.touches[0];
    nodeDrag = { id, el, sx: t.clientX, sy: t.clientY,
      ox: topicPos[id].x, oy: topicPos[id].y };
  }, { passive: true });
});

window.addEventListener('mousemove', e => {
  if (!nodeDrag) return;
  const dx = (e.clientX - nodeDrag.sx) / scale;
  const dy = (e.clientY - nodeDrag.sy) / scale;
  if (Math.abs(dx) < 3 && Math.abs(dy) < 3) return;
  nodeDrag.moved = true;
  const nx = nodeDrag.ox + dx;
  const ny = nodeDrag.oy + dy;
  topicPos[nodeDrag.id].x = nx;
  topicPos[nodeDrag.id].y = ny;
  nodeDrag.el.style.left = nx + 'px';
  nodeDrag.el.style.top = ny + 'px';
  updateNodeLines(nodeDrag.id);
});

window.addEventListener('mouseup', () => {
  if (nodeDrag) {
    if (nodeDrag.moved) nodeWasDragged = true;
    nodeDrag = null;
    // Reset flag after click event fires
    requestAnimationFrame(() => { nodeWasDragged = false; });
  }
});

window.addEventListener('touchmove', e => {
  if (!nodeDrag) return;
  const t = e.touches[0];
  const dx = (t.clientX - nodeDrag.sx) / scale;
  const dy = (t.clientY - nodeDrag.sy) / scale;
  const nx = nodeDrag.ox + dx;
  const ny = nodeDrag.oy + dy;
  topicPos[nodeDrag.id].x = nx;
  topicPos[nodeDrag.id].y = ny;
  nodeDrag.el.style.left = nx + 'px';
  nodeDrag.el.style.top = ny + 'px';
  updateNodeLines(nodeDrag.id);
}, { passive: true });

window.addEventListener('touchend', () => { nodeDrag = null; });

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PAN & ZOOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let scale=1, panX=0, panY=0;
let isDragging=false, startX, startY, wasDragged=false;

function updateTransform() {
  world.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
  updateMinimap();
}

function resetView() {
  const vw=window.innerWidth, vh=window.innerHeight;
  scale = Math.min(vw/2200, vh/2200, 0.55);
  scale = Math.max(scale, 0.25);
  panX = vw/2 - CX*scale;
  panY = vh/2 - CY*scale;
  updateTransform();
}

function zoomIn() { scale=Math.min(scale*1.25,2); updateTransform(); }
function zoomOut() { scale=Math.max(scale/1.25,0.15); updateTransform(); }

const canvasEl = document.getElementById('canvas');

canvasEl.addEventListener('mousedown', e => {
  if (nodeDrag) return;
  isDragging=true;
  wasDragged=false;
  startX=e.clientX-panX;
  startY=e.clientY-panY;
  document.body.classList.add('grabbing');
});

window.addEventListener('mousemove', e => {
  if (!isDragging || nodeDrag) return;
  const dx=e.clientX-startX-panX, dy=e.clientY-startY-panY;
  if (Math.abs(dx)>3||Math.abs(dy)>3) wasDragged=true;
  panX=e.clientX-startX;
  panY=e.clientY-startY;
  updateTransform();
});

window.addEventListener('mouseup', () => {
  isDragging=false;
  document.body.classList.remove('grabbing');
});

canvasEl.addEventListener('wheel', e => {
  e.preventDefault();
  const delta=e.deltaY>0?0.9:1.1;
  const rect=canvasEl.getBoundingClientRect();
  const mx=e.clientX-rect.left, my=e.clientY-rect.top;
  const newScale=Math.min(Math.max(scale*delta,0.15),2);
  const ratio=newScale/scale;
  panX=mx-ratio*(mx-panX);
  panY=my-ratio*(my-panY);
  scale=newScale;
  updateTransform();
}, {passive:false});

// Touch
let lastTouchDist=0;
canvasEl.addEventListener('touchstart', e => {
  if (nodeDrag) return;
  if (e.touches.length===1) {
    isDragging=true; wasDragged=false;
    startX=e.touches[0].clientX-panX;
    startY=e.touches[0].clientY-panY;
  } else if (e.touches.length===2) {
    isDragging=false;
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    lastTouchDist=Math.sqrt(dx*dx+dy*dy);
  }
},{passive:true});

canvasEl.addEventListener('touchmove', e => {
  if (nodeDrag) return;
  e.preventDefault();
  if (e.touches.length===1&&isDragging) {
    panX=e.touches[0].clientX-startX;
    panY=e.touches[0].clientY-startY;
    wasDragged=true;
    updateTransform();
  } else if (e.touches.length===2) {
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const delta=dist/lastTouchDist;
    const mx=(e.touches[0].clientX+e.touches[1].clientX)/2;
    const my=(e.touches[0].clientY+e.touches[1].clientY)/2;
    const newScale=Math.min(Math.max(scale*delta,0.15),2);
    const ratio=newScale/scale;
    panX=mx-ratio*(mx-panX);
    panY=my-ratio*(my-panY);
    scale=newScale;
    lastTouchDist=dist;
    updateTransform();
  }
},{passive:false});

canvasEl.addEventListener('touchend', () => { isDragging=false; });

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MINIMAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateMinimap() {
  const mc=document.getElementById('minimapCanvas');
  const ctx=mc.getContext('2d');
  const W=140, H=100;
  mc.width=W*2; mc.height=H*2;
  mc.style.width=W+'px'; mc.style.height=H+'px';
  ctx.scale(2,2);
  ctx.clearRect(0,0,W,H);
  
  const sx=W/5000, sy=H/5000;
  
  // Structural lines
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  ctx.lineWidth = 0.5;
  grades.forEach(g => {
    ctx.beginPath();
    ctx.moveTo(CX*sx,CY*sy);
    ctx.lineTo(g.x*sx,g.y*sy);
    ctx.stroke();
  });
  
  grades.forEach(g => {
    ctx.fillStyle=g.color+'66';
    ctx.beginPath();
    ctx.arc(g.x*sx,g.y*sy,4,0,Math.PI*2);
    ctx.fill();
  });
  
  topics.forEach(t => {
    const g=grades.find(g=>g.id===t.grade);
    ctx.fillStyle=g.color+'44';
    ctx.beginPath();
    ctx.arc(t.x*sx,t.y*sy,2,0,Math.PI*2);
    ctx.fill();
  });
  
  // Dep lines on minimap when active
  if (depPanelOpen && selectedTopicId) {
    dependencies.forEach(dep => {
      if (dep.isFuture || !depTypeVisible[dep.type]) return;
      if (dep.from !== selectedTopicId && dep.to !== selectedTopicId) return;
      const f = topicPos[dep.from], tt = topicPos[dep.to];
      if (!f||!tt) return;
      const colors = { direct:'#ff6b9d', extends:'#fbbf24', prepares:'#818cf8' };
      ctx.strokeStyle = colors[dep.type]+'88';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(f.x*sx, f.y*sy);
      ctx.lineTo(tt.x*sx, tt.y*sy);
      ctx.stroke();
    });
  }
  
  ctx.fillStyle='#a78bfa44';
  ctx.beginPath();
  ctx.arc(CX*sx,CY*sy,5,0,Math.PI*2);
  ctx.fill();
  
  const vw=window.innerWidth, vh=window.innerHeight;
  const vp=document.getElementById('miniViewport');
  vp.style.left=(-panX/scale*sx)+'px';
  vp.style.top=(-panY/scale*sy)+'px';
  vp.style.width=(vw/scale*sx)+'px';
  vp.style.height=(vh/scale*sy)+'px';
}

window.addEventListener('resize', resetView);
resetView();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const searchClear = document.getElementById('searchClear');

searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim().toLowerCase();
  searchClear.style.display = q ? 'block' : 'none';

  // Remove old highlights
  Object.values(nodeElements).forEach(el => el.classList.remove('search-match'));

  if (!q) {
    searchResults.style.display = 'none';
    return;
  }

  const matches = topics.filter(t => {
    const text = (t.name + ' ' + t.items.join(' ')).toLowerCase();
    return text.includes(q);
  });

  if (matches.length === 0) {
    searchResults.innerHTML = '<div style="padding:12px 14px;font-size:12px;color:var(--muted)">Kein Ergebnis</div>';
    searchResults.style.display = 'block';
    return;
  }

  searchResults.innerHTML = matches.map(t => {
    const g = grades.find(g => g.id === t.grade);
    return `<div class="search-result" data-id="${t.id}">
      <span class="sr-icon">${t.icon}</span>
      <span class="sr-name">${t.name.replace(/\n/g, ' ')}</span>
      <span class="sr-grade" style="color:${g.color}">${g.label}</span>
    </div>`;
  }).join('');

  searchResults.style.display = 'block';

  // Add click handlers
  searchResults.querySelectorAll('.search-result').forEach(el => {
    el.addEventListener('click', () => {
      const id = el.dataset.id;
      focusOnNode(id);
      clearSearch();
    });
  });
});

searchInput.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    clearSearch();
    searchInput.blur();
  }
  if (e.key === 'Enter') {
    const first = searchResults.querySelector('.search-result');
    if (first) {
      focusOnNode(first.dataset.id);
      clearSearch();
    }
  }
});

function clearSearch() {
  searchInput.value = '';
  searchResults.style.display = 'none';
  searchClear.style.display = 'none';
  Object.values(nodeElements).forEach(el => el.classList.remove('search-match'));
}

function focusOnNode(id) {
  const t = topics.find(t => t.id === id);
  if (!t) return;

  // Zoom to the node
  const vw = window.innerWidth, vh = window.innerHeight;
  scale = 0.8;
  panX = vw / 2 - t.x * scale;
  panY = vh / 2 - t.y * scale;
  updateTransform();

  // Highlight & select
  const el = nodeElements[id];
  if (el) el.classList.add('search-match');
  selectTopic(id);

  // Remove highlight after a few seconds
  setTimeout(() => {
    if (el) el.classList.remove('search-match');
  }, 3000);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CLASS FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeFilter = 'all';

function filterGrade(grade) {
  activeFilter = grade;

  // Update button states
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.grade === grade);
  });

  // Update grade visibility
  if (grade === 'all') {
    gradeVisible.k5 = true;
    gradeVisible.k6 = true;
    gradeVisible.k7 = true;
  } else {
    gradeVisible.k5 = grade === 'k5';
    gradeVisible.k6 = grade === 'k6';
    gradeVisible.k7 = grade === 'k7';
  }

  // Apply to nodes
  Object.entries(nodeElements).forEach(([id, el]) => {
    let g;
    if (id.startsWith('k')) {
      g = id;
    } else {
      const t = topics.find(t => t.id === id);
      g = t ? t.grade : null;
    }
    if (!g) return;

    if (grade === 'all' || g === grade) {
      el.classList.remove('grade-hidden');
    } else {
      el.classList.add('grade-hidden');
    }
  });

  // Also hide/show structural paths
  svg.querySelectorAll('path').forEach(p => {
    p.style.opacity = '';
  });

  updateDepVisibility();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ KEYBOARD NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  // Don't capture when typing in search
  if (document.activeElement === searchInput) return;

  switch(e.key) {
    case 'Escape':
      if (infoPanel.classList.contains('show')) {
        closePanel();
        selectedTopicId = null;
        updateDepVisibility();
      } else if (depPanelOpen) {
        toggleDepPanel();
      }
      break;
    case 'f':
    case 'F':
      if (!e.ctrlKey && !e.metaKey) {
        searchInput.focus();
        e.preventDefault();
      }
      break;
    case 'h':
    case 'Home':
      resetView();
      break;
    case '1':
      filterGrade('k5');
      break;
    case '2':
      filterGrade('k6');
      break;
    case '3':
      filterGrade('k7');
      break;
    case '0':
      filterGrade('all');
      break;
    case 'd':
    case 'D':
      toggleDepPanel();
      break;
  }
});
</script>
</body>
</html>
